<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>BUT</title>
    <link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>
    <div style="height: 100%; display: flex; flex-direction: column; align-items: center;">
        <div style="position: relative; flex: 1; width: 100%;">
            <div style="position: absolute; left: 20%; right: 20%; top: 10%; bottom: 10%; border: solid; border-width: 1px; overflow: auto; user-select: none;">
                <div id="bar_space" style="display: flex; flex-direction: column; align-items: center;"></div>
            </div>
        </div>
        <div style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div style="margin: 3px;">
                <label>Server IP</label>
                <input id="server_ip" type="text" />
            </div>
            <div style="margin: 3px;">
                <label>SRC Dir</label>
                <input id="src_dir" type="text" />
            </div>
            <div style="margin: 3px;">
                <label>DST Dir</label>
                <input id="dst_dir" type="text" />
            </div>
            <div style="display: flex;">
                <div id="download_files" class="button" style="user-select: none; border: solid; border-width: 2px; padding: 3px; margin: 10px;">Download Files</div>
                <div id="run_server" class="button" style="user-select: none; border: solid; border-width: 2px; padding: 3px; margin: 10px;">Run Server</div>
                <div id="quit" class="button" style="user-select: none; border: solid; border-width: 2px; padding: 3px; margin: 10px;">Quit</div>
            </div>

            <div style="display: flex; width: 65%; height: 30px; background-color: azure;">
                <div style="position: relative; flex: 1; margin: 3px;">
                    <div id="cur_file_progress_bar" style="position: absolute; width: 20%; height: 100%; background-color: aquamarine;"></div>
                    <div style="display: flex; flex-direction: column; position: absolute; width: 100%; height: 100%; align-items: center;">
                        <div style="flex: 1;"></div>
                        <div id="progress_1_label"></div>
                        <div style="flex: 1;"></div>
                    </div>
                </div>
            </div>

            <div style="display: flex; width: 65%; height: 30px; background-color: azure;">
                <div style="position: relative; flex: 1; margin: 3px;">
                    <div id="overal_progress_bar" style="position: absolute; width: 20%; height: 100%; background-color: aquamarine;"></div>
                    <div style="display: flex; flex-direction: column; position: absolute; width: 100%; height: 100%; align-items: center;">
                        <div style="flex: 1;"></div>
                        <div id="progress_2_label"></div>
                        <div style="flex: 1;"></div>
                    </div>
                </div>
            </div>

        </div>
        <div style="position: relative; flex: 1; width: 100%">
            <div id="info_panel" style="position: absolute; left: 10%; right: 10%; top: 20%; bottom: 20%; overflow: auto; border: solid; border-width: 1px; user-select: none; padding: 5px;"></div>
        </div>
    </div>

    <script>
        var fileHashesSrc;
        var fileHashesDst;

        const progress1 = [0, 0];
        const progress2 = [0, 0];

        function log(str) {
            const infoPanel = document.getElementById('info_panel');

            const div = document.createElement("div");
            div.innerHTML = str;
            infoPanel.appendChild(div);
        }

        function createBar() {
            const template = document.createElement('div');

            const src = `
<div style="display: flex; width: 90%; height: 30px; background-color: azure; margin-bottom: 5px;">
    <div style="position: relative; flex: 1; margin: 3px;">
        <div myId="bar" style="position: absolute; width: 20%; height: 100%; background-color: aquamarine;"></div>
        <div style="display: flex; flex-direction: column; position: absolute; width: 100%; height: 100%; align-items: center;">
            <div style="flex: 1;"></div>
            <div myId="label"></div>
            <div style="flex: 1;"></div>
        </div>
    </div>
</div>
`
            template.innerHTML = src;
            const res = template.children[0];

            return res;
        }

        const { startServer, getRecs } = require('./scripts/httpserver');
        const { getRecords, readPrefs, flushPrefs, getFileList } = require('./scripts/files');

        document.prefs = {};

        async function initPrefs() {
            const srcDir = document.getElementById('src_dir');
            const dstDir = document.getElementById('dst_dir');
            const serverIP = document.getElementById('server_ip');

            document.prefs = await readPrefs();
            const prefs = document.prefs;

            srcDir.value = prefs.srcDir;
            dstDir.value = prefs.dstDir;
            serverIP.value = prefs.serverIP;

            srcDir.addEventListener('change', event => {
                prefs.srcDir = srcDir.value;
                flushPrefs(prefs);
            });
            dstDir.addEventListener('change', event => {
                prefs.dstDir = dstDir.value;
                flushPrefs(prefs);
            });
            serverIP.addEventListener('change', event => {
                prefs.serverIP = serverIP.value;
                flushPrefs(prefs);
            });
        }
        initPrefs();

        var myFileList = undefined;
        async function initButtons() {
            const path = require('path');
            const { getSendFunc } = await require('./scripts/pipeserver');

            await startServer();
            log('HTTP server running.')

            const { exec } = require('child_process');
            //exec(path.join(__dirname, '..\\out\\build\\x64-debug\\Main\\Main.exe'));

            log('Waiting for backend...');
            const send = await getSendFunc();

            log('Backend running!');

            document.getElementById("download_files").addEventListener('click', async event => {
                const fileList = await getRecs();
                log('File list acquired.')


                progress2[1] = fileList.length;
                progress2[0] = 0;

                const { writeFile, createFolders } = require('./scripts/files');

                function* filesIt() {
                    for (let i = 0; i < fileList.length; ++i) {
                        yield {
                            fileEntry: fileList[i],
                            index: i
                        };
                    }
                }

                const it = filesIt();

                let currentlyDownloading = 0;
                let downloaded = 0;

                await new Promise((resolve, reject) => {

                    function startDownloading() {
                        if (currentlyDownloading > 5) {
                            return;
                        }

                        let cur = it.next();
                        if (!cur.value) {
                            return;
                        }

                        const { fileEntry, index } = cur.value;
                        
                        log(`Downloading ${fileEntry.path} (${fileEntry.fileSize / 1000} KB)...`);

                        ++currentlyDownloading;

                        const pr = new Promise(async (resolve, reject) => {
                            const fileId = index;
                            let checkProgress = true;
                            document.curFile = fileEntry;

                            if (fileEntry.fileSize === 0) {
                                await writeFile(document.prefs.dstDir, fileEntry.path, []);
                                resolve();
                                return;
                            }

                            await createFolders(document.prefs.dstDir, fileEntry.path);

                            send({
                                op: 'run_udp_client',
                                fileId: fileId,
                                ip_addr: document.prefs.serverIP,
                                fileSize: fileEntry.fileSize,
                                path: path.join(document.prefs.dstDir, fileEntry.path)
                            }).then(() => {
                                checkProgress = false;
                                if (bar) {
                                    bar.parentNode.removeChild(bar);
                                }
                                resolve();
                            });

                            let bar;
                            let prBar;
                            let label;

                            async function reqProgress() {
                                if (!checkProgress) {
                                    return;
                                }

                                const prog = await send({
                                    op: 'get_download_progress',
                                    fileId: fileId,
                                });

                                if (!checkProgress) {
                                    return;
                                }

                                if (prog.progress[0] > 0) {
                                    if (!bar) {
                                        bar = createBar();
                                        prBar = bar.querySelector('div[myId="bar"]');
                                        label = bar.querySelector('div[myId="label"]');

                                        document.getElementById('bar_space').appendChild(bar);
                                    }

                                    let progress = 0;
                                    if (prog.progress[1] > 0) {
                                        progress = prog.progress[0] / prog.progress[1];
                                    }
                                    prBar.style.width = `${100 * progress}%`;
                                    label.innerHTML = `${fileEntry.path} [${prog.progress[0]}/${prog.progress[1]}]`;
                                }

                                setTimeout(reqProgress, 10);
                            }

                            reqProgress();
                        });

                        pr.then(() => {
                            ++downloaded;
                            if (downloaded >= fileList.length) {
                                resolve();
                            }
                            --currentlyDownloading;
                            startDownloading();
                        });

                        startDownloading();
                    }

                    startDownloading();
                });

                log('Download Complete!');

                let myFiles = [];
                {
                    progress2[0] = 0;
                    progress2[1] = fileList.length;

                    const path = require('path');
                    myFiles = fileList.map((x, index) => {
                        return {
                            path: path.join(document.prefs.dstDir, x.path)
                        };
                    });
                    let reqs = myFiles.map((x, index) => {
                        const req = {
                            op: 'hash',
                            file: x.path
                        };

                        const pr = send(req);
                        pr.then(() => {
                            if (!pr.fulfilled) {
                                ++progress2[0];
                            }
                            pr.fulfilled = true;
                        });
                        return pr;
                    });

                    for (let i = 0; i < reqs.length; ++i) {
                        reqs[i] = await reqs[i];
                        myFiles[i].fileSize = reqs[i].fileSize;
                        myFiles[i].hash = reqs[i].hash;
                    }

                    console.log(myFiles);
                }

                fileHashesSrc = fileList;
                fileHashesDst = myFiles;
            });


            document.getElementById("run_server").addEventListener('click', async event => {
                myFileList = new Promise(async (resolve, reject) => {

                    let fileList = await getFileList(document.prefs.srcDir);
                    progress2[1] = fileList.length;

                    log('Calculating file hashes...');
                    {
                        let reqs = fileList.map((x, index) => {
                            const path = require('path');
                            const req = {
                                op: 'hash',
                                file: path.join(document.prefs.srcDir, x.path)
                            };
            
                            const pr = send(req);
                            pr.then(() => {
                                if (!pr.fulfilled) {
                                    ++progress2[0];
                                }
                                pr.fulfilled = true;
                            });
                            return pr;
                        });

                        for (let i = 0; i < reqs.length; ++i) {
                            reqs[i] = await reqs[i];
                            fileList[reqs[i].id].hash = reqs[i].hash;
                            fileList[reqs[i].id].fileSize = reqs[i].fileSize;
                        }
                    }

                    {
                        let reqs = fileList.map((x, index) => {
                            const path = require('path');
                            const req = {
                                op: 'set_file_id',
                                file: path.join(document.prefs.srcDir, x.path),
                                file_id: index
                            };

                            const pr = send(req);
                            return pr;
                        });

                        for (let i = 0; i < reqs.length; ++i) {
                            await reqs[i];
                        }
                    }

                    resolve(fileList);
                });

                const fileList = await myFileList;

                console.log(fileList);

                await send({
                    op: 'run_udp_server'
                });
                log('UDP server running.')

                return;
            });

            document.getElementById("quit").addEventListener('click', async event => {
                send({
                    op: 'shutdown'
                });
            });

            function updateProgressBar(progressValue, bar, label){
                let progress = 0; 
                if (progressValue[1] !== 0) {
                    progress = progressValue[0] / progressValue[1];
                }

                bar.style.width = `${100 * progress}%`;
                label.innerHTML = `[${progressValue[0]}/${progressValue[1]}]`;

                setTimeout(() => {
                    updateProgressBar(progressValue, bar, label);
                }, 10);
            };

            {
                const bar1 = document.getElementById('cur_file_progress_bar');
                const bar2 = document.getElementById('overal_progress_bar');

                const label1 = document.getElementById('progress_1_label');
                const label2 = document.getElementById('progress_2_label');

                updateProgressBar(progress1, bar1, label1);
                updateProgressBar(progress2, bar2, label2);
            }
        }

        initButtons();

    </script>
</body>
</html>
